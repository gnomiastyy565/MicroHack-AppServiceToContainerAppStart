name: Build, Push Docker Image and Deploy to Azure

on:
  push:
    branches:
      - main
  pull_request:

permissions:
  id-token: write

jobs:
  build-push-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    # 1️⃣ Log in to Azure
    - name: Log in to Azure
      uses: azure/login@v1
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    # 2️⃣ Log in to Azure Container Registry
    - name: Log in to Azure Container Registry
      uses: azure/docker-login@v1
      with:
        login-server: ${{ secrets.ACR_LOGIN_SERVER }}
        username: ${{ secrets.ACR_USERNAME }}
        password: ${{ secrets.ACR_PASSWORD }}

    # 3️⃣ Get latest image tag and increment
    - name: Get Latest Container Image Tag
      id: get_tag
      run: |
        TAG=$(az acr repository show-tags \
          --name ${{ secrets.ACR_NAME }} \
          --repository microhack-app \
          --orderby time_desc \
          --output tsv --detail | head -n 1 | awk '{print $4}')
        NUMERIC_TAG=$(echo "$TAG" | grep -oE '[0-9]+')
        if [ -z "$NUMERIC_TAG" ]; then
          NUMERIC_TAG=0
        fi
        INCREMENTED_TAG=$((NUMERIC_TAG + 1))
        UPDATED_TAG=$(echo "$TAG" | sed "s/$NUMERIC_TAG/$INCREMENTED_TAG/")
        echo "image_tag=$UPDATED_TAG" >> $GITHUB_OUTPUT

    # 4️⃣ Build Docker image with new tag
    - name: Build Docker image
      run: |
        docker build -t ${{ secrets.ACR_LOGIN_SERVER }}/microhack-app:${{ steps.get_tag.outputs.image_tag }} .

    # 5️⃣ Push Docker image to ACR
    - name: Push Docker image to ACR
      run: |
        docker push ${{ secrets.ACR_LOGIN_SERVER }}/microhack-app:${{ steps.get_tag.outputs.image_tag }}

    # 6️⃣ Deploy to Azure Container App
    - name: Deploy to Azure Container App
      run: |
        az containerapp update \
          --name microhack-app \
          --resource-group MicroHackRG \
          --image ${{ secrets.ACR_LOGIN_SERVER }}/microhack-app:${{ steps.get_tag.outputs.image_tag }}
